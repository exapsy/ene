{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "ENE Test Suite Configuration",
  "description": "Configuration schema for ENE (End-to-End) test suites. Supports multiple test types: HTTP API testing, PostgreSQL database testing, MongoDB database testing, and MinIO object storage testing. Each suite can define fixtures, service units (databases, mocks, applications), and test cases with rich assertions.",
  "type": "object",
  "properties": {
    "kind": {
      "type": "string",
      "const": "e2e_test:v1"
    },
    "name": {
      "type": "string"
    },
    "debug": {
      "type": "boolean",
      "description": "Enable debug output for all tests in this suite"
    },
    "fixtures": {
      "type": "array",
      "items": {
        "type": "object",
        "description": "A fixture is a single key-value mapping. Format: '- fixtureName: value' for inline values or '- fixtureName: { file: ./path.json }' for file-based fixtures. Example: '- api_key: test-123' or '- test_data: { file: ./data.json }'",
        "minProperties": 1,
        "maxProperties": 1,
        "additionalProperties": {
          "oneOf": [
            {
              "type": ["string", "number", "boolean"],
              "description": "Simple primitive value"
            },
            {
              "type": "object",
              "properties": {
                "file": {
                  "type": "string",
                  "description": "Path to file containing the fixture value"
                }
              },
              "required": ["file"],
              "additionalProperties": false,
              "description": "Complex fixture with file reference"
            }
          ]
        }
      }
    },
    "units": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "name": {
            "type": "string"
          },
          "kind": {
            "type": "string",
            "description": "Type of service unit: 'http' (application service), 'httpmock' (mock HTTP server), 'mongo' (MongoDB database), 'postgres' (PostgreSQL database), 'minio' (object storage)",
            "enum": ["mongo", "http", "postgres", "httpmock", "minio"]
          },
          "image": {
            "type": "string"
          },
          "dockerfile": {
            "type": "string"
          },
          "env_file": {
            "type": "string"
          },
          "cmd": {
            "type": "array",
            "items": {
              "type": "string"
            },
            "nullable": true
          },
          "healthcheck": {
            "type": "string",
            "nullable": true
          },
          "app_port": {
            "type": "integer",
            "nullable": true
          },
          "env": {
            "type": "array",
            "items": {
              "type": "string"
            },
            "additionalProperties": {
              "type": "string"
            },
            "nullable": true
          },
          "startup_timeout": {
            "type": "string",
            "description": "optional startup timeout for the unit"
          },
          "build_timeout": {
            "type": "string",
            "description": "optional build timeout for the unit"
          },
          "routes": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "path": {
                  "type": "string"
                },
                "method": {
                  "type": "string"
                },
                "response": {
                  "type": "object",
                  "properties": {
                    "status": {
                      "type": "integer"
                    },
                    "body": {},
                    "headers": {
                      "type": "object",
                      "additionalProperties": {
                        "type": "string"
                      }
                    },
                    "delay": {
                      "type": "string",
                      "description": "Delay before responding (e.g., '2s', '500ms'). Simulates slow endpoints.",
                      "pattern": "^[0-9]+(ns|us|Âµs|ms|s|m|h)$"
                    }
                  }
                }
              },
              "required": ["path", "method", "response"]
            }
          },
          "access_key": {
            "type": "string",
            "description": "Minio access key"
          },
          "secret_key": {
            "type": "string",
            "description": "Minio secret key"
          },
          "console_port": {
            "type": "integer",
            "description": "Minio console port"
          },
          "buckets": {
            "type": "array",
            "items": {
              "type": "string"
            },
            "description": "List of buckets to create"
          },
          "database": {
            "type": "string",
            "description": "Database name (for PostgreSQL and MongoDB units)"
          },
          "user": {
            "type": "string",
            "description": "Database user name (for PostgreSQL and MongoDB units)"
          },
          "password": {
            "type": "string",
            "description": "Database password (for PostgreSQL and MongoDB units)"
          },
          "migrations": {
            "type": "string",
            "description": "Path to migrations: JavaScript file for MongoDB (e.g., 'db.js'), or directory containing .sql files for PostgreSQL (e.g., './migrations')"
          }
        },
        "allOf": [
          {
            "if": {
              "properties": {
                "kind": {
                  "const": "mongo"
                }
              }
            },
            "then": {
              "properties": {
                "migrations": {
                  "type": "string",
                  "description": "The path to the migrations js file."
                }
              }
            }
          }
        ],
        "additionalProperties": false,
        "required": ["name", "kind", "app_port"]
      }
    },
    "target": {
      "type": "string",
      "description": "The name of the target unit to run the tests against. This is used to determine which unit to run the tests against."
    },
    "tests": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "name": {
            "type": "string",
            "minLength": 1
          },
          "kind": {
            "type": "string",
            "description": "Type of test to execute: 'http' (HTTP API test), 'postgres' (PostgreSQL database test), 'mongo' (MongoDB database test), 'minio' (MinIO storage test)",
            "enum": ["http", "minio", "postgres", "mongo"]
          },
          "target": {
            "type": "string",
            "description": "Override suite-level target. Specifies which unit to send requests to for this test."
          },
          "debug": {
            "type": "boolean",
            "description": "Enable debug output for this specific test (overrides suite-level debug)"
          },
          "timeout": {
            "type": "string"
          },
          "query": {
            "type": "string",
            "description": "SQL query to execute (postgres test only)"
          },
          "collection": {
            "type": "string",
            "description": "MongoDB collection name (mongo test only)"
          },
          "filter": {
            "oneOf": [
              {
                "type": "string",
                "description": "MongoDB filter as JSON string"
              },
              {
                "type": "object",
                "description": "MongoDB filter as YAML object"
              }
            ],
            "description": "MongoDB find filter (mongo test only)"
          },
          "pipeline": {
            "oneOf": [
              {
                "type": "string",
                "description": "MongoDB aggregation pipeline as JSON string"
              },
              {
                "type": "array",
                "description": "MongoDB aggregation pipeline as YAML array",
                "items": {
                  "type": "object"
                }
              }
            ],
            "description": "MongoDB aggregation pipeline (mongo test only)"
          },
          "request": {
            "type": "object",
            "properties": {
              "method": {
                "type": "string",
                "enum": [
                  "GET",
                  "POST",
                  "PUT",
                  "DELETE",
                  "PATCH",
                  "HEAD",
                  "OPTIONS"
                ]
              },
              "path": {
                "type": "string"
              },
              "body": {
                "type": "string"
              },
              "timeout": {
                "type": "string"
              },
              "headers": {
                "type": "object",
                "additionalProperties": {
                  "type": "string"
                }
              },
              "query_params": {
                "type": "object",
                "additionalProperties": {
                  "type": "string"
                }
              },
              "bucket": {
                "type": "string",
                "description": "Minio bucket name"
              },
              "object": {
                "type": "string",
                "description": "Minio object key"
              },
              "action": {
                "type": "string",
                "enum": [
                  "list_buckets",
                  "list_objects",
                  "get_object",
                  "stat_object",
                  "bucket_exists",
                  "object_exists",
                  "put_object"
                ],
                "description": "Minio action to perform"
              },
              "content": {
                "type": "string",
                "description": "Content for put_object action"
              },
              "prefix": {
                "type": "string",
                "description": "Prefix for list_objects action"
              }
            }
          },
          "verify_state": {
            "type": "object",
            "properties": {
              "required": {
                "type": "object",
                "properties": {
                  "buckets": {
                    "type": "object",
                    "additionalProperties": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "properties": {
                          "path": {
                            "type": "string"
                          },
                          "min_size": {
                            "type": "string"
                          },
                          "max_size": {
                            "type": "string"
                          },
                          "max_age": {
                            "type": "string"
                          },
                          "content_type": {
                            "type": "string"
                          },
                          "pattern": {
                            "type": "string"
                          }
                        },
                        "required": ["path"]
                      }
                    }
                  },
                  "files": {
                    "type": "array",
                    "items": {
                      "type": "object",
                      "properties": {
                        "path": {
                          "type": "string"
                        },
                        "min_size": {
                          "type": "string"
                        },
                        "max_size": {
                          "type": "string"
                        },
                        "max_age": {
                          "type": "string"
                        },
                        "content_type": {
                          "type": "string"
                        },
                        "pattern": {
                          "type": "string"
                        }
                      },
                      "required": ["path"]
                    }
                  }
                }
              },
              "forbidden": {
                "type": "object",
                "properties": {
                  "buckets": {
                    "type": "object",
                    "additionalProperties": {
                      "type": "array",
                      "items": {
                        "type": "string"
                      }
                    }
                  },
                  "files": {
                    "type": "array",
                    "items": {
                      "type": "string"
                    }
                  }
                }
              },
              "constraints": {
                "type": "array",
                "items": {
                  "type": "object",
                  "properties": {
                    "bucket": {
                      "type": "string"
                    },
                    "file_count": {
                      "oneOf": [{ "type": "integer" }, { "type": "string" }]
                    },
                    "max_total_size": {
                      "type": "string"
                    },
                    "min_total_size": {
                      "type": "string"
                    },
                    "total_buckets": {
                      "type": "string"
                    },
                    "empty_buckets": {
                      "type": "string"
                    }
                  }
                }
              },
              "files_exist": {
                "type": "array",
                "items": {
                  "type": "string"
                }
              },
              "bucket_counts": {
                "type": "object",
                "additionalProperties": {
                  "type": "integer"
                }
              }
            }
          },
          "expect": {
            "type": "object",
            "properties": {
              "status_code": {
                "type": "integer"
              },
              "bucket_asserts": {
                "type": "array",
                "items": {
                  "type": "object",
                  "properties": {
                    "name": {
                      "type": "string"
                    },
                    "present": {
                      "type": "boolean"
                    },
                    "created_date": {
                      "type": "string"
                    }
                  },
                  "required": ["name"]
                }
              },
              "object_asserts": {
                "type": "array",
                "items": {
                  "type": "object",
                  "properties": {
                    "key": {
                      "type": "string"
                    },
                    "present": {
                      "type": "boolean"
                    },
                    "size": {
                      "type": "integer"
                    },
                    "content_type": {
                      "type": "string"
                    },
                    "etag": {
                      "type": "string"
                    }
                  },
                  "required": ["key"]
                }
              },
              "content_assert": {
                "type": "object",
                "properties": {
                  "equals": {
                    "type": "string"
                  },
                  "contains": {
                    "type": "string"
                  },
                  "not_contains": {
                    "type": "string"
                  },
                  "matches": {
                    "type": "string"
                  },
                  "not_matches": {
                    "type": "string"
                  },
                  "min_length": {
                    "type": "integer"
                  },
                  "max_length": {
                    "type": "integer"
                  }
                }
              },
              "count_assert": {
                "type": "object",
                "properties": {
                  "equals": {
                    "type": "integer"
                  },
                  "greater_than": {
                    "type": "integer"
                  },
                  "less_than": {
                    "type": "integer"
                  },
                  "at_least": {
                    "type": "integer"
                  },
                  "at_most": {
                    "type": "integer"
                  }
                }
              },
              "exists_assert": {
                "type": "object",
                "properties": {
                  "bucket": {
                    "type": "boolean"
                  },
                  "object": {
                    "type": "boolean"
                  }
                }
              },
              "body_asserts": {
                "type": "object",
                "description": "Map of JSON paths to assertion specs. Values can be strings (shorthand for equals) or objects with explicit assertions.",
                "additionalProperties": {
                  "oneOf": [
                    {
                      "type": [
                        "string",
                        "number",
                        "integer",
                        "boolean",
                        "null"
                      ],
                      "description": "Shorthand for equals assertion"
                    },
                    {
                      "type": "object",
                      "properties": {
                        "equals": {
                          "type": [
                            "string",
                            "number",
                            "integer",
                            "boolean",
                            "null"
                          ]
                        },
                        "not_equals": {
                          "type": [
                            "string",
                            "number",
                            "integer",
                            "boolean",
                            "null"
                          ]
                        },
                        "contains": {
                          "type": "string"
                        },
                        "not_contains": {
                          "type": "string"
                        },
                        "matches": {
                          "type": "string"
                        },
                        "not_matches": {
                          "type": "string"
                        },
                        "present": {
                          "type": "boolean"
                        },
                        "length": {
                          "type": "integer",
                          "minimum": 0
                        },
                        "size": {
                          "type": "integer",
                          "minimum": 0
                        },
                        ">": {
                          "type": "integer",
                          "description": "Greater than"
                        },
                        "<": {
                          "type": "integer",
                          "description": "Less than"
                        },
                        "greater_than": {
                          "type": "integer"
                        },
                        "less_than": {
                          "type": "integer"
                        },
                        "type": {
                          "type": "string",
                          "enum": [
                            "string",
                            "int",
                            "float",
                            "bool",
                            "array",
                            "object"
                          ]
                        },
                        "contains_where": {
                          "type": "object",
                          "description": "Check if array contains at least one item matching all conditions",
                          "additionalProperties": true
                        },
                        "all_match": {
                          "type": "object",
                          "description": "Check if all array items match conditions",
                          "additionalProperties": true
                        },
                        "none_match": {
                          "type": "object",
                          "description": "Check if no array items match conditions",
                          "additionalProperties": true
                        }
                      },
                      "additionalProperties": false
                    }
                  ]
                }
              },
              "header_asserts": {
                "type": "object",
                "description": "Map of header names to assertion specs. Values can be strings (shorthand for equals) or objects with explicit assertions.",
                "additionalProperties": {
                  "oneOf": [
                    {
                      "type": [
                        "string",
                        "number",
                        "integer",
                        "boolean",
                        "null"
                      ],
                      "description": "Shorthand for equals assertion"
                    },
                    {
                      "type": "object",
                      "properties": {
                        "equals": {
                          "type": [
                            "string",
                            "number",
                            "integer",
                            "boolean",
                            "null"
                          ]
                        },
                        "not_equals": {
                          "type": [
                            "string",
                            "number",
                            "integer",
                            "boolean",
                            "null"
                          ]
                        },
                        "contains": {
                          "type": "string"
                        },
                        "not_contains": {
                          "type": "string"
                        },
                        "matches": {
                          "type": "string"
                        },
                        "not_matches": {
                          "type": "string"
                        },
                        "present": {
                          "type": "boolean"
                        }
                      },
                      "additionalProperties": false
                    }
                  ]
                }
              },
              "row_count": {
                "type": "integer",
                "description": "Expected exact number of rows returned by the SQL query (postgres test only)"
              },
              "min_row_count": {
                "type": "integer",
                "description": "Minimum number of rows expected from SQL query (postgres test only)"
              },
              "max_row_count": {
                "type": "integer",
                "description": "Maximum number of rows expected from SQL query (postgres test only)"
              },
              "no_rows": {
                "type": "boolean",
                "description": "Assert that the SQL query returns no rows (postgres test only)"
              },
              "table_exists": {
                "type": "string",
                "description": "Verify that a PostgreSQL table exists in the database (postgres test only)"
              },
              "rows": {
                "type": "array",
                "description": "Assert exact row data matches from SQL query results (postgres test only)",
                "items": {
                  "type": "object",
                  "additionalProperties": true
                }
              },
              "column_values": {
                "type": "object",
                "description": "Assert specific column values for single-row SQL query results (postgres test only)",
                "additionalProperties": true
              },
              "contains": {
                "type": "array",
                "description": "Assert that SQL query results contain these rows with partial match (postgres test) or MongoDB query results contain these documents (mongo test)",
                "items": {
                  "type": "object",
                  "additionalProperties": true
                }
              },
              "not_contains": {
                "type": "array",
                "description": "Assert SQL query results don't contain these rows (postgres test) or MongoDB query results don't contain these documents (mongo test)",
                "items": {
                  "type": "object",
                  "additionalProperties": true
                }
              },
              "document_count": {
                "type": "integer",
                "description": "Assert exact document count (mongo test only)"
              },
              "min_document_count": {
                "type": "integer",
                "description": "Assert minimum document count (mongo test only)"
              },
              "max_document_count": {
                "type": "integer",
                "description": "Assert maximum document count (mongo test only)"
              },
              "no_documents": {
                "type": "boolean",
                "description": "Assert query returns zero documents (mongo test only)"
              },
              "collection_exists": {
                "type": "string",
                "description": "Verify a MongoDB collection exists (mongo test only)"
              },
              "documents": {
                "type": "array",
                "description": "Assert exact document data matches (mongo test only)",
                "items": {
                  "type": "object",
                  "additionalProperties": true
                }
              },
              "field_values": {
                "type": "object",
                "description": "Assert field values for single document (mongo test only)",
                "additionalProperties": true
              }
            }
          }
        },
        "allOf": [
          {
            "if": {
              "properties": {
                "kind": {
                  "const": "minio"
                }
              }
            },
            "then": {
              "anyOf": [
                {
                  "required": ["name", "kind", "verify_state"]
                },
                {
                  "required": ["name", "kind", "request", "expect"]
                }
              ]
            }
          },
          {
            "if": {
              "properties": {
                "kind": {
                  "const": "postgres"
                }
              }
            },
            "then": {
              "required": ["name", "kind", "expect"]
            }
          },
          {
            "if": {
              "properties": {
                "kind": {
                  "const": "http"
                }
              }
            },
            "then": {
              "required": ["name", "kind", "request", "expect"]
            }
          },
          {
            "if": {
              "properties": {
                "kind": {
                  "const": "mongo"
                }
              }
            },
            "then": {
              "required": ["name", "kind", "expect"]
            }
          }
        ]
      }
    }
  },
  "required": ["kind", "name", "units", "target", "tests"],
  "additionalProperties": false
}
