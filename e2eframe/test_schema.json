{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "type": "object",
  "properties": {
    "kind": {
      "type": "string",
      "const": "e2e_test:v1"
    },
    "name": {
      "type": "string"
    },
    "fixtures": {
      "type": "array",
      "items": {
        "type": "object",
        "description": "A fixture is a single key-value mapping. Format: '- fixtureName: value' for inline values or '- fixtureName: { file: ./path.json }' for file-based fixtures. Example: '- api_key: test-123' or '- test_data: { file: ./data.json }'",
        "minProperties": 1,
        "maxProperties": 1,
        "additionalProperties": {
          "oneOf": [
            {
              "type": ["string", "number", "boolean"],
              "description": "Simple primitive value"
            },
            {
              "type": "object",
              "properties": {
                "file": {
                  "type": "string",
                  "description": "Path to file containing the fixture value"
                }
              },
              "required": ["file"],
              "additionalProperties": false,
              "description": "Complex fixture with file reference"
            }
          ]
        }
      }
    },
    "units": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "name": {
            "type": "string"
          },
          "kind": {
            "type": "string",
            "enum": ["mongo", "http", "postgres", "httpmock", "minio"]
          },
          "image": {
            "type": "string"
          },
          "dockerfile": {
            "type": "string"
          },
          "env_file": {
            "type": "string"
          },
          "cmd": {
            "type": "array",
            "items": {
              "type": "string"
            },
            "nullable": true
          },
          "healthcheck": {
            "type": "string",
            "nullable": true
          },
          "app_port": {
            "type": "integer",
            "nullable": true
          },
          "env": {
            "type": "array",
            "items": {
              "type": "string"
            },
            "additionalProperties": {
              "type": "string"
            },
            "nullable": true
          },
          "startup_timeout": {
            "type": "string",
            "description": "optional startup timeout for the unit"
          },
          "build_timeout": {
            "type": "string",
            "description": "optional build timeout for the unit"
          },
          "routes": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "path": {
                  "type": "string"
                },
                "method": {
                  "type": "string"
                },
                "response": {
                  "type": "object",
                  "properties": {
                    "status": {
                      "type": "integer"
                    },
                    "body": {},
                    "headers": {
                      "type": "object",
                      "additionalProperties": {
                        "type": "string"
                      }
                    },
                    "delay": {
                      "type": "string",
                      "description": "Delay before responding (e.g., '2s', '500ms'). Simulates slow endpoints.",
                      "pattern": "^[0-9]+(ns|us|Âµs|ms|s|m|h)$"
                    }
                  }
                }
              },
              "required": ["path", "method", "response"]
            }
          },
          "access_key": {
            "type": "string",
            "description": "Minio access key"
          },
          "secret_key": {
            "type": "string",
            "description": "Minio secret key"
          },
          "console_port": {
            "type": "integer",
            "description": "Minio console port"
          },
          "buckets": {
            "type": "array",
            "items": {
              "type": "string"
            },
            "description": "List of buckets to create"
          },
          "database": {
            "type": "string",
            "description": "PostgreSQL database name"
          },
          "user": {
            "type": "string",
            "description": "PostgreSQL user name"
          },
          "password": {
            "type": "string",
            "description": "PostgreSQL password"
          },
          "migrations": {
            "type": "string",
            "description": "Path to the migrations file (MongoDB only)"
          }
        },
        "allOf": [
          {
            "if": {
              "properties": {
                "kind": {
                  "const": "mongo"
                }
              }
            },
            "then": {
              "properties": {
                "migrations": {
                  "type": "string",
                  "description": "The path to the migrations js file."
                }
              }
            }
          }
        ],
        "additionalProperties": false,
        "required": ["name", "kind", "app_port"]
      }
    },
    "target": {
      "type": "string",
      "description": "The name of the target unit to run the tests against. This is used to determine which unit to run the tests against."
    },
    "tests": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "name": {
            "type": "string",
            "minLength": 1
          },
          "kind": {
            "type": "string",
            "oneOf": [
              {
                "const": "http"
              },
              {
                "const": "minio"
              },
              {
                "const": "postgres"
              }
            ]
          },
          "target": {
            "type": "string",
            "description": "Override suite-level target. Specifies which unit to send requests to for this test."
          },
          "timeout": {
            "type": "string"
          },
          "query": {
            "type": "string",
            "description": "SQL query to execute (postgres test only)"
          },
          "request": {
            "type": "object",
            "properties": {
              "method": {
                "type": "string",
                "enum": [
                  "GET",
                  "POST",
                  "PUT",
                  "DELETE",
                  "PATCH",
                  "HEAD",
                  "OPTIONS"
                ]
              },
              "path": {
                "type": "string"
              },
              "body": {
                "type": "string"
              },
              "timeout": {
                "type": "string"
              },
              "headers": {
                "type": "object",
                "additionalProperties": {
                  "type": "string"
                }
              },
              "query_params": {
                "type": "object",
                "additionalProperties": {
                  "type": "string"
                }
              },
              "bucket": {
                "type": "string",
                "description": "Minio bucket name"
              },
              "object": {
                "type": "string",
                "description": "Minio object key"
              },
              "action": {
                "type": "string",
                "enum": [
                  "list_buckets",
                  "list_objects",
                  "get_object",
                  "stat_object",
                  "bucket_exists",
                  "object_exists",
                  "put_object"
                ],
                "description": "Minio action to perform"
              },
              "content": {
                "type": "string",
                "description": "Content for put_object action"
              },
              "prefix": {
                "type": "string",
                "description": "Prefix for list_objects action"
              }
            }
          },
          "verify_state": {
            "type": "object",
            "properties": {
              "required": {
                "type": "object",
                "properties": {
                  "buckets": {
                    "type": "object",
                    "additionalProperties": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "properties": {
                          "path": {
                            "type": "string"
                          },
                          "min_size": {
                            "type": "string"
                          },
                          "max_size": {
                            "type": "string"
                          },
                          "max_age": {
                            "type": "string"
                          },
                          "content_type": {
                            "type": "string"
                          },
                          "pattern": {
                            "type": "string"
                          }
                        },
                        "required": ["path"]
                      }
                    }
                  },
                  "files": {
                    "type": "array",
                    "items": {
                      "type": "object",
                      "properties": {
                        "path": {
                          "type": "string"
                        },
                        "min_size": {
                          "type": "string"
                        },
                        "max_size": {
                          "type": "string"
                        },
                        "max_age": {
                          "type": "string"
                        },
                        "content_type": {
                          "type": "string"
                        },
                        "pattern": {
                          "type": "string"
                        }
                      },
                      "required": ["path"]
                    }
                  }
                }
              },
              "forbidden": {
                "type": "object",
                "properties": {
                  "buckets": {
                    "type": "object",
                    "additionalProperties": {
                      "type": "array",
                      "items": {
                        "type": "string"
                      }
                    }
                  },
                  "files": {
                    "type": "array",
                    "items": {
                      "type": "string"
                    }
                  }
                }
              },
              "constraints": {
                "type": "array",
                "items": {
                  "type": "object",
                  "properties": {
                    "bucket": {
                      "type": "string"
                    },
                    "file_count": {
                      "oneOf": [{ "type": "integer" }, { "type": "string" }]
                    },
                    "max_total_size": {
                      "type": "string"
                    },
                    "min_total_size": {
                      "type": "string"
                    },
                    "total_buckets": {
                      "type": "string"
                    },
                    "empty_buckets": {
                      "type": "string"
                    }
                  }
                }
              },
              "files_exist": {
                "type": "array",
                "items": {
                  "type": "string"
                }
              },
              "bucket_counts": {
                "type": "object",
                "additionalProperties": {
                  "type": "integer"
                }
              }
            }
          },
          "expect": {
            "type": "object",
            "properties": {
              "status_code": {
                "type": "integer"
              },
              "bucket_asserts": {
                "type": "array",
                "items": {
                  "type": "object",
                  "properties": {
                    "name": {
                      "type": "string"
                    },
                    "present": {
                      "type": "boolean"
                    },
                    "created_date": {
                      "type": "string"
                    }
                  },
                  "required": ["name"]
                }
              },
              "object_asserts": {
                "type": "array",
                "items": {
                  "type": "object",
                  "properties": {
                    "key": {
                      "type": "string"
                    },
                    "present": {
                      "type": "boolean"
                    },
                    "size": {
                      "type": "integer"
                    },
                    "content_type": {
                      "type": "string"
                    },
                    "etag": {
                      "type": "string"
                    }
                  },
                  "required": ["key"]
                }
              },
              "content_assert": {
                "type": "object",
                "properties": {
                  "equals": {
                    "type": "string"
                  },
                  "contains": {
                    "type": "string"
                  },
                  "not_contains": {
                    "type": "string"
                  },
                  "matches": {
                    "type": "string"
                  },
                  "not_matches": {
                    "type": "string"
                  },
                  "min_length": {
                    "type": "integer"
                  },
                  "max_length": {
                    "type": "integer"
                  }
                }
              },
              "count_assert": {
                "type": "object",
                "properties": {
                  "equals": {
                    "type": "integer"
                  },
                  "greater_than": {
                    "type": "integer"
                  },
                  "less_than": {
                    "type": "integer"
                  },
                  "at_least": {
                    "type": "integer"
                  },
                  "at_most": {
                    "type": "integer"
                  }
                }
              },
              "exists_assert": {
                "type": "object",
                "properties": {
                  "bucket": {
                    "type": "boolean"
                  },
                  "object": {
                    "type": "boolean"
                  }
                }
              },
              "body_asserts": {
                "type": "object",
                "description": "Map of JSON paths to assertion specs. Values can be strings (shorthand for equals) or objects with explicit assertions.",
                "additionalProperties": {
                  "oneOf": [
                    {
                      "type": [
                        "string",
                        "number",
                        "integer",
                        "boolean",
                        "null"
                      ],
                      "description": "Shorthand for equals assertion"
                    },
                    {
                      "type": "object",
                      "properties": {
                        "equals": {
                          "type": [
                            "string",
                            "number",
                            "integer",
                            "boolean",
                            "null"
                          ]
                        },
                        "not_equals": {
                          "type": [
                            "string",
                            "number",
                            "integer",
                            "boolean",
                            "null"
                          ]
                        },
                        "contains": {
                          "type": "string"
                        },
                        "not_contains": {
                          "type": "string"
                        },
                        "matches": {
                          "type": "string"
                        },
                        "not_matches": {
                          "type": "string"
                        },
                        "present": {
                          "type": "boolean"
                        },
                        "length": {
                          "type": "integer",
                          "minimum": 0
                        },
                        "size": {
                          "type": "integer",
                          "minimum": 0
                        },
                        ">": {
                          "type": "integer",
                          "description": "Greater than"
                        },
                        "<": {
                          "type": "integer",
                          "description": "Less than"
                        },
                        "greater_than": {
                          "type": "integer"
                        },
                        "less_than": {
                          "type": "integer"
                        },
                        "type": {
                          "type": "string",
                          "enum": [
                            "string",
                            "int",
                            "float",
                            "bool",
                            "array",
                            "object"
                          ]
                        },
                        "contains_where": {
                          "type": "object",
                          "description": "Check if array contains at least one item matching all conditions",
                          "additionalProperties": true
                        },
                        "all_match": {
                          "type": "object",
                          "description": "Check if all array items match conditions",
                          "additionalProperties": true
                        },
                        "none_match": {
                          "type": "object",
                          "description": "Check if no array items match conditions",
                          "additionalProperties": true
                        }
                      },
                      "additionalProperties": false
                    }
                  ]
                }
              },
              "header_asserts": {
                "type": "object",
                "description": "Map of header names to assertion specs. Values can be strings (shorthand for equals) or objects with explicit assertions.",
                "additionalProperties": {
                  "oneOf": [
                    {
                      "type": [
                        "string",
                        "number",
                        "integer",
                        "boolean",
                        "null"
                      ],
                      "description": "Shorthand for equals assertion"
                    },
                    {
                      "type": "object",
                      "properties": {
                        "equals": {
                          "type": [
                            "string",
                            "number",
                            "integer",
                            "boolean",
                            "null"
                          ]
                        },
                        "not_equals": {
                          "type": [
                            "string",
                            "number",
                            "integer",
                            "boolean",
                            "null"
                          ]
                        },
                        "contains": {
                          "type": "string"
                        },
                        "not_contains": {
                          "type": "string"
                        },
                        "matches": {
                          "type": "string"
                        },
                        "not_matches": {
                          "type": "string"
                        },
                        "present": {
                          "type": "boolean"
                        }
                      },
                      "additionalProperties": false
                    }
                  ]
                }
              },
              "row_count": {
                "type": "integer",
                "description": "Expected exact number of rows returned by the query"
              },
              "min_row_count": {
                "type": "integer",
                "description": "Minimum number of rows expected"
              },
              "max_row_count": {
                "type": "integer",
                "description": "Maximum number of rows expected"
              },
              "no_rows": {
                "type": "boolean",
                "description": "Assert that the query returns no rows"
              },
              "table_exists": {
                "type": "string",
                "description": "Check if a table exists in the database"
              },
              "rows": {
                "type": "array",
                "description": "Expected exact row data",
                "items": {
                  "type": "object",
                  "additionalProperties": true
                }
              },
              "column_values": {
                "type": "object",
                "description": "Expected column values for single-row results",
                "additionalProperties": true
              },
              "contains": {
                "type": "array",
                "description": "Assert that results contain these rows (partial match)",
                "items": {
                  "type": "object",
                  "additionalProperties": true
                }
              },
              "not_contains": {
                "type": "array",
                "description": "Assert that results do not contain these rows",
                "items": {
                  "type": "object",
                  "additionalProperties": true
                }
              }
            }
          }
        },
        "allOf": [
          {
            "if": {
              "properties": {
                "kind": {
                  "const": "minio"
                }
              }
            },
            "then": {
              "anyOf": [
                {
                  "required": ["name", "kind", "verify_state"]
                },
                {
                  "required": ["name", "kind", "request", "expect"]
                }
              ]
            }
          },
          {
            "if": {
              "properties": {
                "kind": {
                  "const": "postgres"
                }
              }
            },
            "then": {
              "required": ["name", "kind", "expect"]
            }
          },
          {
            "if": {
              "properties": {
                "kind": {
                  "const": "http"
                }
              }
            },
            "then": {
              "required": ["name", "kind", "request", "expect"]
            }
          }
        ]
      }
    }
  },
  "required": ["kind", "name", "units", "target", "tests"],
  "additionalProperties": false
}
